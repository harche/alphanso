name: "Openshift kubernetes rebase"
max_attempts: 100

# Working directory for main script and validators (relative to config file location)
working_directory: "kubernetes"

# Pre-actions - One-time setup
# When using CLI: pre-actions run in the directory containing this config file
# When using API: pre-actions run in current directory (unless config_directory specified)
# This allows pre-actions to:
#   - Find scripts next to config file (e.g., ./setup.sh)
#   - Create/setup the working_directory
pre_actions:
  - command: "bash -c './setup.sh --fork-repo=git@github.com:harche/kubernetes.git'"
    description: "Setup kubernetes fork repository (creates kubernetes/ directory)"

# Main script - The goal to retry until it succeeds (runs in working_directory)
main_script:
  command: "bash -c '../ocp-rebase.sh --k8s-tag=v1.35.0-alpha.2 --openshift-release=release-4.22'"
  description: "Rebase OpenShift kubernetes fork to upstream tag"
  timeout: 600

# Validators - Health checks (only run when main script fails, run in working_directory)
validators:
  - type: command
    name: "Go mod tidy"
    command: "bash -c 'go mod tidy'"
    timeout: 300

  - type: command
    name: "Vendor update script"
    command: "bash -c 'hack/update-vendor.sh'"
    timeout: 600

  - type: command
    name: "Go work vendor"
    command: "bash -c 'go work vendor'"
    timeout: 300

  - type: command
    name: "Install etcd"
    command: "bash -c 'source hack/install-etcd.sh'"
    timeout: 300

  - type: command
    name: "Codegen Update"
    command: "bash -c 'source hack/install-etcd.sh && hack/update-codegen.sh'"
    timeout: 600

  - type: command
    name: "Make update"
    command: "bash -c 'source hack/install-etcd.sh ; make update'"
    timeout: 600

  - type: command
    name: "Build"
    command: "bash -c 'make'"
    timeout: 600

  - type: test-suite
    name: "Unit Tests"
    command: "bash -c 'make test'"
    timeout: 1800

# Agent configuration
agent:
  type: "claude-agent-sdk"
  claude:
    model: "claude-sonnet-4-5@20250929"
    system_prompt_file: "prompts/rebase-assistant.txt"

retry_strategy:
  type: hybrid
